<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RoleServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">classes in demo Coverage Results</a> &gt; <a href="index.source.html" class="el_package">login.permission.project.classes.service</a> &gt; <span class="el_source">RoleServiceTest.java</span></div><h1>RoleServiceTest.java</h1><pre class="source lang-java linenums">package login.permission.project.classes.service;

import jakarta.servlet.http.HttpServletRequest;
import login.permission.project.classes.model.Permission;
import login.permission.project.classes.model.Role;
import login.permission.project.classes.model.ServerResponse;
import login.permission.project.classes.model.dto.RoleDTO;
import login.permission.project.classes.model.util.JwtUtil;
import login.permission.project.classes.repository.PermissionRepository;
import login.permission.project.classes.repository.RoleRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * RoleService 的單元測試類
 */
<span class="fc" id="L28">public class RoleServiceTest {</span>

  @Mock
  private RoleRepository roleRepository;

  @Mock
  private PermissionRepository permissionRepository;

  @Mock
  private JwtUtil jwtUtil;

  @Mock
  private HttpServletRequest request;

  @InjectMocks
  private RoleService roleService;

  @BeforeEach
  void setUp() {
<span class="fc" id="L47">    MockitoAnnotations.openMocks(this);</span>
<span class="fc" id="L48">  }</span>

  /**
   * 測試獲取所有角色
   */
  @Test
  void whenGetAllRole_thenSuccess() {
    // 準備測試資料
<span class="fc" id="L56">    List&lt;Role&gt; mockRoles = Arrays.asList(</span>
            new Role(1, &quot;ADMIN&quot;, new HashSet&lt;&gt;()),
            new Role(2, &quot;USER&quot;, new HashSet&lt;&gt;())
    );

<span class="fc" id="L61">    when(roleRepository.findAll()).thenReturn(mockRoles);</span>

    // 執行測試
<span class="fc" id="L64">    ResponseEntity&lt;ServerResponse&gt; response = roleService.getAllRole();</span>

    // 驗證結果
<span class="fc" id="L67">    assertEquals(HttpStatus.OK, response.getStatusCode());</span>
<span class="fc" id="L68">    assertEquals(&quot;查詢所有角色成功&quot;, response.getBody().getMessage());</span>
<span class="fc" id="L69">    assertEquals(2, ((List&lt;Role&gt;)response.getBody().getData()).size());</span>
<span class="fc" id="L70">    verify(roleRepository, times(1)).findAll();</span>
<span class="fc" id="L71">  }</span>

  /**
   * 測試成功創建角色
   */
  @Test
  void whenCreateRole_thenSuccess() {
    // 準備測試資料
<span class="fc" id="L79">    RoleDTO roleDto = new RoleDTO();</span>
<span class="fc" id="L80">    roleDto.setRoleName(&quot;TEST_ROLE&quot;);</span>
<span class="fc" id="L81">    roleDto.setPermission_id(new String[]{&quot;1&quot;, &quot;2&quot;});</span>

<span class="fc" id="L83">    Permission permission1 = new Permission(1, &quot;PERM1&quot;, &quot;category&quot;, &quot;desc&quot;);</span>
<span class="fc" id="L84">    Permission permission2 = new Permission(2, &quot;PERM2&quot;, &quot;category&quot;, &quot;desc&quot;);</span>
<span class="fc" id="L85">    List&lt;Permission&gt; permissions = Arrays.asList(permission1, permission2);</span>

    // Mock 所需的行為
<span class="fc" id="L88">    doNothing().when(jwtUtil).validateRequest(any(HttpServletRequest.class));</span>
<span class="fc" id="L89">    when(permissionRepository.findAllById(any())).thenReturn(permissions);</span>
<span class="fc" id="L90">    when(roleRepository.save(any(Role.class))).thenReturn(new Role());</span>

    // 執行測試
<span class="fc" id="L93">    ResponseEntity&lt;ServerResponse&gt; response = roleService.createRole(roleDto, request);</span>

    // 驗證結果
<span class="fc" id="L96">    assertEquals(HttpStatus.OK, response.getStatusCode());</span>
<span class="fc" id="L97">    assertEquals(&quot;新增角色成功&quot;, response.getBody().getMessage());</span>
<span class="fc" id="L98">    verify(roleRepository, times(1)).save(any(Role.class));</span>
<span class="fc" id="L99">  }</span>

  /**
   * 測試創建角色時無權限的情況
   */
  @Test
  void whenCreateRole_withoutPermission_thenFail() {
    // 準備測試資料
<span class="fc" id="L107">    RoleDTO roleDto = new RoleDTO();</span>
<span class="fc" id="L108">    roleDto.setRoleName(&quot;TEST_ROLE&quot;);</span>

    // Mock 拋出異常的情況
<span class="fc" id="L111">    doThrow(new IllegalArgumentException()).when(jwtUtil).validateRequest(any(HttpServletRequest.class));</span>

    // 執行測試
<span class="fc" id="L114">    ResponseEntity&lt;ServerResponse&gt; response = roleService.createRole(roleDto, request);</span>

    // 驗證結果
<span class="fc" id="L117">    assertEquals(HttpStatus.UNAUTHORIZED, response.getStatusCode());</span>
<span class="fc" id="L118">    assertEquals(&quot;你沒有新增角色的權限&quot;, response.getBody().getMessage());</span>
<span class="fc" id="L119">    verify(roleRepository, never()).save(any(Role.class));</span>
<span class="fc" id="L120">  }</span>

  /**
   * 測試成功更新角色
   */
  @Test
  void whenUpdateRole_thenSuccess() {
    // 準備測試資料
<span class="fc" id="L128">    RoleDTO roleDto = new RoleDTO();</span>
<span class="fc" id="L129">    roleDto.setRole_id(1);</span>
<span class="fc" id="L130">    roleDto.setRoleName(&quot;UPDATED_ROLE&quot;);</span>
<span class="fc" id="L131">    roleDto.setPermission_id(new String[]{&quot;1&quot;});</span>

<span class="fc" id="L133">    Role existingRole = new Role(1, &quot;OLD_ROLE&quot;, new HashSet&lt;&gt;());</span>
<span class="fc" id="L134">    Permission permission = new Permission(1, &quot;PERM1&quot;, &quot;category&quot;, &quot;desc&quot;);</span>

    // Mock 所需的行為
<span class="fc" id="L137">    doNothing().when(jwtUtil).validateRequest(any(HttpServletRequest.class));</span>
<span class="fc" id="L138">    when(roleRepository.findById(1)).thenReturn(Optional.of(existingRole));</span>
<span class="fc" id="L139">    when(permissionRepository.findAllById(any())).thenReturn(Collections.singletonList(permission));</span>
<span class="fc" id="L140">    when(roleRepository.save(any(Role.class))).thenReturn(existingRole);</span>

    // 執行測試
<span class="fc" id="L143">    ResponseEntity&lt;ServerResponse&gt; response = roleService.updateRole(roleDto, request);</span>

    // 驗證結果
<span class="fc" id="L146">    assertEquals(HttpStatus.OK, response.getStatusCode());</span>
<span class="fc" id="L147">    assertEquals(&quot;修改角色成功&quot;, response.getBody().getMessage());</span>
<span class="fc" id="L148">    verify(roleRepository, times(1)).save(any(Role.class));</span>
<span class="fc" id="L149">  }</span>

  /**
   * 測試更新不存在的角色
   */
  @Test
  void whenUpdateRole_roleNotFound_thenFail() {
    // 準備測試資料
<span class="fc" id="L157">    RoleDTO roleDto = new RoleDTO();</span>
<span class="fc" id="L158">    roleDto.setRole_id(999);</span>
<span class="fc" id="L159">    roleDto.setRoleName(&quot;NON_EXISTENT_ROLE&quot;);</span>

    // Mock 所需的行為
<span class="fc" id="L162">    doNothing().when(jwtUtil).validateRequest(any(HttpServletRequest.class));</span>
<span class="fc" id="L163">    when(roleRepository.findById(999)).thenReturn(Optional.empty());</span>

    // 執行測試
<span class="fc" id="L166">    ResponseEntity&lt;ServerResponse&gt; response = roleService.updateRole(roleDto, request);</span>

    // 驗證結果
<span class="fc" id="L169">    assertEquals(HttpStatus.NOT_FOUND, response.getStatusCode());</span>
<span class="fc" id="L170">    assertEquals(&quot;找不到指定id的角色&quot;, response.getBody().getMessage());</span>
<span class="fc" id="L171">    verify(roleRepository, never()).save(any(Role.class));</span>
<span class="fc" id="L172">  }</span>

  /**
   * 測試更新角色時無權限的情況
   */
  @Test
  void whenUpdateRole_withoutPermission_thenFail() {
    // 準備測試資料
<span class="fc" id="L180">    RoleDTO roleDto = new RoleDTO();</span>
<span class="fc" id="L181">    roleDto.setRole_id(1);</span>
<span class="fc" id="L182">    roleDto.setRoleName(&quot;TEST_ROLE&quot;);</span>

    // Mock 拋出異常的情況
<span class="fc" id="L185">    doThrow(new IllegalArgumentException()).when(jwtUtil).validateRequest(any(HttpServletRequest.class));</span>

    // 執行測試
<span class="fc" id="L188">    ResponseEntity&lt;ServerResponse&gt; response = roleService.updateRole(roleDto, request);</span>

    // 驗證結果
<span class="fc" id="L191">    assertEquals(HttpStatus.UNAUTHORIZED, response.getStatusCode());</span>
<span class="fc" id="L192">    assertEquals(&quot;你沒有修改角色的權限&quot;, response.getBody().getMessage());</span>
<span class="fc" id="L193">    verify(roleRepository, never()).save(any(Role.class));</span>
<span class="fc" id="L194">  }</span>

  /**
   * 測試創建角色時權限ID格式錯誤
   */
  @Test
  void whenCreateRole_withInvalidPermissionId_thenFail() {
    // 準備測試資料
<span class="fc" id="L202">    RoleDTO roleDto = new RoleDTO();</span>
<span class="fc" id="L203">    roleDto.setRoleName(&quot;TEST_ROLE&quot;);</span>
<span class="fc" id="L204">    roleDto.setPermission_id(new String[]{&quot;invalid_id&quot;}); // 非數字的ID</span>

    // Mock 所需的行為
<span class="fc" id="L207">    doNothing().when(jwtUtil).validateRequest(any(HttpServletRequest.class));</span>

    // 執行測試
<span class="fc" id="L210">    ResponseEntity&lt;ServerResponse&gt; response = roleService.createRole(roleDto, request);</span>

    // 驗證結果
<span class="fc" id="L213">    assertEquals(HttpStatus.UNAUTHORIZED, response.getStatusCode());</span>
<span class="fc" id="L214">    verify(roleRepository, never()).save(any(Role.class));</span>
<span class="fc" id="L215">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>